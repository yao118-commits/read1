<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡åœ’é–±è®€æ‰“å¡ç‰† - è¨˜éŒ„ä½ çš„é–±è®€æ—…ç¨‹</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Google Font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f7f9fb; /* æ·ºç°è‰²èƒŒæ™¯ */
        }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ï¼Œè®“å®ƒçœ‹èµ·ä¾†æ›´ç¾è§€ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* gray-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8; /* gray-400 */
        }
        /* éš±è—åŸç”Ÿç®­é ­ */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* è‡ªå®šç¾©ç„¦é»æ•ˆæœï¼Œè®“è¼¸å…¥æ¡†æ›´çªå‡º */
        .input-glow:focus {
            outline: none;
            border-color: #f87171; /* red-400 */
            box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.4);
        }
        
        /* Custom CSS for Toggle Switch */
        .toggle-checkbox {
            top: 0;
            right: 0;
            margin: 0;
            transition: right 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }
        .toggle-checkbox:checked {
            right: 1.25rem; /* ~20px */
        }
        .toggle-label {
            background-color: #fca5a5; /* Red-300 */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #dc2626; /* Red-600 */
        }
    </style>
</head>
<body class="p-4 lg:p-8">

    <!-- Header æ¨™é¡Œå€ (å¢åŠ æ¼¸å±¤æ•ˆæœ) -->
    <header class="text-center mb-8 lg:mb-12">
        <h1 class="text-3xl lg:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-pink-500 mb-2">
            ğŸ“š æ ¡åœ’é–±è®€æ‰“å¡ç‰†
        </h1>
        <p class="text-lg text-gray-600">
            è¨˜éŒ„ä½ çš„é–±è®€æ—…ç¨‹ï¼Œåˆ†äº«ä½ çš„å¥‡æ€å¦™æƒ³ï¼(å…§å»ºfirebaseè³‡æ–™åº«)
        </p>
    </header>

    <!-- Main Content ä¸»è¦å…§å®¹å€ -->
    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6 lg:gap-8">
        
        <!-- å·¦å´: æ‰“å¡è¡¨å–® (Check-in Form) -->
        <section class="lg:col-span-1">
            
            <!-- Admin Configuration Interface (ç®¡ç†ä»‹é¢) -->
            <div id="adminConfig" class="bg-red-50 p-4 rounded-xl shadow-inner border border-red-200 mb-6 hidden">
                <h3 class="text-lg font-bold text-red-700 mb-3 flex items-center">
                    <!-- Icon: Setting Gear -->
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.49 3.17a.75.75 0 01-1.06 0L8.7 1.95a.75.75 0 10-1.06 1.06L9.43 4.23a.75.75 0 010 1.06L7.64 7.08a.75.75 0 101.06 1.06l1.73-1.73a.75.75 0 011.06 0l1.73 1.73a.75.75 0 101.06-1.06l-1.73-1.73a.75.75 0 010-1.06l1.73-1.73a.75.75 0 10-1.06-1.06L11.49 3.17zM5.5 10a.5.5 0 01.5-.5h4a.5.5 0 010 1H6a.5.5 0 01-.5-.5zM5 15.5a.5.5 0 01.5-.5h4a.5.5 0 010 1H5.5a.5.5 0 01-.5-.5z" clip-rule="evenodd" /></svg>
                    <span>ç®¡ç†å“¡è¨­å®šèˆ‡å·¥å…·</span>
                </h3>
                <div class="flex items-center justify-between">
                    <label for="allowCommentsToggle" class="text-sm font-medium text-red-800">å…è¨±æ–°å¢ç•™è¨€</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <!-- Toggle Checkbox: controlled by JS -->
                        <input type="checkbox" name="allowComments" id="allowCommentsToggle" onchange="handleConfigChange(event)"
                            class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <!-- Toggle Label -->
                        <label for="allowCommentsToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                </div>
                
                <!-- NEW: è³‡æ–™ç®¡ç†å€ -->
                <div class="mt-4 border-t pt-4 border-red-200">
                    <h4 class="text-base font-bold text-red-700 mb-2">è³‡æ–™ç®¡ç†</h4>
                    <div class="space-y-2">
                        <!-- åŒ¯å‡ºè³‡æ–™ -->
                        <button onclick="handleExportData()" 
                            class="w-full text-left p-2 bg-red-200 hover:bg-red-300 rounded-lg text-sm text-red-800 font-medium transition duration-150">
                            ğŸ’¾ åŒ¯å‡ºè³‡æ–™ (JSON)
                        </button>
                        
                        <!-- åŒ¯å…¥è³‡æ–™ (éœ€è¦æ–‡ä»¶é¸æ“‡) -->
                        <input type="file" id="importFileInput" accept=".json" class="hidden" onchange="handleImportData(event)">
                        <button onclick="document.getElementById('importFileInput').click()" 
                            class="w-full text-left p-2 bg-red-200 hover:bg-red-300 rounded-lg text-sm text-red-800 font-medium transition duration-150">
                            ğŸ“¤ åŒ¯å…¥è³‡æ–™ (JSON)
                        </button>
                        
                        <!-- æ¸…ç©ºè³‡æ–™ -->
                        <button onclick="handleClearDataPrompt()" id="clearDataButton"
                            class="w-full text-left p-2 bg-red-500 hover:bg-red-600 rounded-lg text-sm text-white font-medium transition duration-150 shadow-md">
                            ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™
                        </button>
                        <!-- ç®¡ç†å“¡æ“ä½œè¨Šæ¯é¡¯ç¤ºå€ -->
                        <p id="adminMessage" class="text-sm mt-1 text-red-600 hidden"></p>
                    </div>
                </div>
                <!-- END NEW -->

            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-2xl border border-red-100 sticky top-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-3 border-red-200">æˆ‘è¦æ‰“å¡ï¼</h2>
                
                <form id="checkinForm" onsubmit="handleCheckin(event)">
                    
                    <!-- ç­ç´šè¼¸å…¥ (å·²ä¿®æ”¹ placeholder) -->
                    <div class="mb-4">
                        <label for="classSelect" class="block text-sm font-medium text-gray-700 mb-1">ç­ç´šåç¨±</label>
                        <input type="text" id="classSelect" required placeholder="è«‹è¼¸å…¥ç­ç´šåç¨± (ä¾‹å¦‚: 301)"
                            class="w-full p-2.5 bg-white border border-gray-300 text-gray-900 text-sm rounded-lg transition duration-200 input-glow">
                    </div>

                    <!-- å§“åè¼¸å…¥ (å·²ä¿®æ”¹ label) -->
                    <div class="mb-4">
                        <label for="nameInput" class="block text-sm font-medium text-gray-700 mb-1">å§“å</label>
                        <input type="text" id="nameInput" required placeholder="è«‹è¼¸å…¥å§“å"
                            class="w-full p-2.5 bg-white border border-gray-300 text-gray-900 text-sm rounded-lg transition duration-200 input-glow">
                    </div>
                    
                    <!-- æ›¸åè¼¸å…¥ -->
                    <div class="mb-4">
                        <label for="bookTitle" class="block text-sm font-medium text-gray-700 mb-1">æ›¸å</label>
                        <input type="text" id="bookTitle" required placeholder="è¼¸å…¥æˆ–é¸æ“‡æ›¸å"
                            class="w-full p-2.5 bg-white border border-gray-300 text-gray-900 text-sm rounded-lg transition duration-200 input-glow">
                    </div>

                    <!-- é æ•¸ç¯„åœ -->
                    <div class="mb-4 flex space-x-3">
                        <div class="flex-1">
                            <label for="startPage" class="block text-sm font-medium text-gray-700 mb-1">å¾ç¬¬å¹¾é </label>
                            <input type="number" id="startPage" required min="1" placeholder="ä¾‹å¦‚: 1"
                                class="w-full p-2.5 bg-white border border-gray-300 text-gray-900 text-sm rounded-lg transition duration-200 input-glow">
                        </div>
                        <div class="flex-1">
                            <label for="endPage" class="block text-sm font-medium text-gray-700 mb-1">åˆ°ç¬¬å¹¾é </label>
                            <input type="number" id="endPage" required min="1" placeholder="ä¾‹å¦‚: 10"
                                class="w-full p-2.5 bg-white border border-gray-300 text-gray-900 text-sm rounded-lg transition duration-200 input-glow">
                        </div>
                    </div>

                    <!-- é–±è®€æƒ³æ³• (500å­—ä»¥å…§) -->
                    <div class="mb-4">
                        <label for="thoughts" class="block text-sm font-medium text-gray-700 mb-1">
                            é–±è®€æ™‚è…¦ä¸­ç”¢ç”Ÿçš„æƒ³æ³• (500å­—ä»¥å…§)
                        </label>
                        <textarea id="thoughts" required maxlength="500" placeholder="å¯«ä¸‹ä½ çš„å°å®‡å®™..."
                            class="w-full p-2.5 bg-white border border-gray-300 text-gray-900 text-sm rounded-lg transition duration-200 input-glow h-24 resize-none"></textarea>
                    </div>

                    <!-- æˆ‘çš„å¿ƒæƒ… (Emoji Selector) -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æˆ‘çš„å¿ƒæƒ…</label>
                        <div id="moodSelector" class="flex flex-wrap gap-2 justify-start">
                            <!-- Emojis as radio buttons: checked state has a border/ring -->
                            <input type="radio" id="mood1" name="mood" value="ğŸ¥°" class="hidden" required>
                            <label for="mood1" class="text-2xl p-2 rounded-full cursor-pointer hover:bg-red-50 transition duration-150 ring-2 ring-transparent has-[:checked]:ring-red-400 has-[:checked]:bg-red-100">ğŸ¥°</label>
                            
                            <input type="radio" id="mood2" name="mood" value="ğŸ˜‚" class="hidden">
                            <label for="mood2" class="text-2xl p-2 rounded-full cursor-pointer hover:bg-red-50 transition duration-150 ring-2 ring-transparent has-[:checked]:ring-red-400 has-[:checked]:bg-red-100">ğŸ˜‚</label>

                            <input type="radio" id="mood3" name="mood" value="ğŸ¤”" class="hidden">
                            <label for="mood3" class="text-2xl p-2 rounded-full cursor-pointer hover:bg-red-50 transition duration-150 ring-2 ring-transparent has-[:checked]:ring-red-400 has-[:checked]:bg-red-100">ğŸ¤”</label>
                            
                            <input type="radio" id="mood4" name="mood" value="ğŸ˜­" class="hidden">
                            <label for="mood4" class="text-2xl p-2 rounded-full cursor-pointer hover:bg-red-50 transition duration-150 ring-2 ring-transparent has-[:checked]:ring-red-400 has-[:checked]:bg-red-100">ğŸ˜­</label>
                            
                            <input type="radio" id="mood5" name="mood" value="ğŸ¤©" class="hidden">
                            <label for="mood5" class="text-2xl p-2 rounded-full cursor-pointer hover:bg-red-50 transition duration-150 ring-2 ring-transparent has-[:checked]:ring-red-400 has-[:checked]:bg-red-100">ğŸ¤©</label>

                            <input type="radio" id="mood6" name="mood" value="ğŸ˜µâ€ğŸ’«" class="hidden">
                            <label for="mood6" class="text-2xl p-2 rounded-full cursor-pointer hover:bg-red-50 transition duration-150 ring-2 ring-transparent has-[:checked]:ring-red-400 has-[:checked]:bg-red-100">ğŸ˜µâ€ğŸ’«</label>
                        </div>
                    </div>
                    
                    <!-- æäº¤æŒ‰éˆ• (ä½¿ç”¨æ›´æ·±çš„é™°å½±å’Œæ¼¸å±¤) -->
                    <button type="submit" id="submitButton"
                        class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white font-semibold py-3 px-4 rounded-xl hover:from-red-700 hover:to-red-800 transition duration-300 shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-red-300">
                        é€å‡ºæ‰“å¡ç´€éŒ„
                    </button>
                    <p id="messageBox" class="text-sm text-center mt-3 text-red-500 hidden"></p>
                </form>
            </div>
        </section>

        <!-- å³å´: é–±è®€ç´€éŒ„ç‰† (Reading Records Wall) -->
        <section class="lg:col-span-3">
            <div class="flex justify-between items-baseline mb-5">
                <h2 class="text-2xl font-bold text-gray-800">å¤§å®¶çš„é–±è®€ç´€éŒ„</h2>
                <span id="currentUserIdDisplay" class="text-xs font-mono text-gray-500"></span>
            </div>
            
            <!-- ç¯©é¸å™¨ Filters (å„ªåŒ–æ¨£å¼) -->
            <div class="flex flex-wrap gap-3 mb-6 p-4 bg-white rounded-xl shadow-md border border-gray-200">
                <!-- ç­ç´šç¯©é¸ä¸‹æ‹‰é¸å–® (ç”± JS å¡«å……) -->
                <select id="classFilterSelect"
                    class="p-2 border border-gray-300 rounded-lg text-sm bg-white hover:border-red-400 transition duration-150">
                    <!-- Options will be populated by JS -->
                </select>

                <!-- NEW: æ™‚é–“ç¯©é¸ä¸‹æ‹‰é¸å–® -->
                <select id="timeFilterSelect"
                    class="p-2 border border-gray-300 rounded-lg text-sm bg-white hover:border-red-400 transition duration-150">
                    <option value="all">æ‰€æœ‰æ™‚é–“</option>
                    <option value="today">æœ¬æ—¥</option>
                    <option value="3days">ä¸‰æ—¥</option>
                    <option value="thisweek">æœ¬é€±</option>
                    <option value="2weeks">äºŒé€±</option>
                    <option value="thismonth">æœ¬æœˆ</option>
                    <option value="6months">åŠå¹´</option>
                    <option value="1year">ä¸€å¹´</option>
                </select>
                
                <!-- å§“åç¯©é¸è¼¸å…¥æ¡† -->
                <input type="text" id="nameFilterInput" placeholder="ä¾å§“åç¯©é¸..." 
                    class="p-2 border border-gray-300 rounded-lg text-sm max-w-40 hover:border-red-400 transition duration-150">
                <!-- æ›¸åç¯©é¸è¼¸å…¥æ¡† -->
                <input type="text" id="bookTitleFilterInput" placeholder="ä¾æ›¸åç¯©é¸..." 
                    class="p-2 border border-gray-300 rounded-lg text-sm max-w-40 hover:border-red-400 transition duration-150">
                
                <!-- æ’åºä¸‹æ‹‰é¸å–® (å·²æ·»åŠ  ID å’Œå€¼) -->
                <select id="sortSelect"
                    class="p-2 border border-gray-300 rounded-lg text-sm bg-white ml-auto hover:border-red-400 transition duration-150">
                    <option value="latest">ä¾æœ€æ–°æ’åº</option>
                    <option value="likes">ä¾è®šæ•¸æ’åº</option>
                </select>
                
                <button onclick="clearFilters()" class="bg-gray-200 hover:bg-red-100 text-gray-700 hover:text-red-700 font-medium py-2 px-3 rounded-lg text-sm transition duration-150">
                    æ¸…é™¤ç¯©é¸
                </button>
            </div>
            
            <!-- ç´€éŒ„åˆ—è¡¨ Records List -->
            <div id="recordsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6 custom-scrollbar">
                <!-- Record Cards will be inserted here by JavaScript -->
                <div class="text-center text-gray-500 p-8 bg-white rounded-xl shadow-lg md:col-span-2" id="loadingIndicator">
                    è¼‰å…¥ä¸­... è«‹ç¨å€™ã€‚
                </div>
            </div>
        </section>

    </main>
    
    <!-- åˆªé™¤ç¢ºèª/ç®¡ç†å“¡æ“ä½œç¢ºèªæ¨¡æ…‹è¦–çª— (Modal) -->
    <div id="confirmationModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full transform transition-transform duration-300 scale-100">
            <h3 class="text-xl font-bold text-red-600 mb-4">ç¢ºèªåˆªé™¤ç´€éŒ„</h3>
            <p class="text-gray-700 mb-6">æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™æ¢é–±è®€æ‰“å¡ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="flex justify-end space-x-3">
                <!-- æ³¨æ„: cancelDelete å’Œ confirmDelete å·²ç¶“è¢«ä¿®æ”¹ç‚ºé€šç”¨çš„è™•ç†å‡½æ•¸ -->
                <button onclick="cancelDelete()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 font-medium">
                    å–æ¶ˆ
                </button>
                <button onclick="confirmDelete()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150 font-medium shadow-md">
                    ç¢ºèªåˆªé™¤
                </button>
            </div>
        </div>
    </div>
    
    <!-- æ–°å¢ç•™è¨€æ¨¡æ…‹è¦–çª— (Modal) -->
    <div id="commentModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-transform duration-300 scale-100">
            <h3 class="text-xl font-bold text-blue-600 mb-4">æ–°å¢ç•™è¨€</h3>
            <p class="text-gray-700 mb-4">è«‹ç•™ä¸‹æ‚¨å°é€™ç¯‡æ‰“å¡ç´€éŒ„çš„æƒ³æ³•æˆ–é¼“å‹µï¼</p>
            <form id="commentForm" onsubmit="handleCommentSubmit(event)">
                
                <!-- ä¿®æ”¹: é¡¯ç¤ºä¸å¯ä¿®æ”¹çš„ç”¨æˆ¶ID (ç¾åœ¨é¡¯ç¤ºå®Œæ•´ ID) -->
                <div class="mb-4 p-3 bg-gray-100 rounded-lg border border-gray-300">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ‚¨çš„èº«ä»½ (å®Œæ•´ ID)</label>
                    <p id="commentUserIdDisplay" class="text-sm font-mono text-gray-800 break-all"></p>
                </div>
                
                <textarea id="commentText" required maxlength="200" placeholder="æœ€å¤š200å­—..."
                    class="w-full p-3 mb-4 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg resize-none h-24 focus:ring-blue-500 focus:border-blue-500"></textarea>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="cancelComment()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 font-medium">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" id="commentSubmitButton" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 font-medium shadow-md">
                        é€å‡ºç•™è¨€
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- å…¨æ–‡æ”¾å¤§/é‚„åŸæ¨¡æ…‹è¦–çª— (Full Post Modal) - NEW FEATURE -->
    <div id="fullPostModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-3xl w-full mx-4 lg:mx-auto max-h-[90vh] overflow-y-auto transform transition-transform duration-300 scale-100">
            <div class="flex justify-between items-start border-b pb-3 mb-4">
                <h3 id="fullPostTitle" class="text-2xl font-bold text-red-600"></h3>
                <button onclick="closeFullPostModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="fullPostContent" class="space-y-4 text-gray-700">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // åŒ¯å…¥ Firebase å¿…è¦çš„æ¨¡çµ„ (æ–°å¢ getDocs ä»¥ä¾›åŒ¯å‡º/æ¸…ç©ºä½¿ç”¨)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // ç¢ºä¿åŒ¯å…¥äº† arrayRemove, arrayUnion, increment, getDocs
        import { getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot, doc, setDoc, getDoc, setLogLevel, deleteDoc, arrayUnion, arrayRemove, updateDoc, increment, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ç’°å¢ƒèˆ‡å…¨åŸŸè®Šæ•¸å®£å‘Š ---
        // ç®¡ç†å“¡ ID åˆ—è¡¨ï¼Œæ‚¨å¯ä»¥æ–°å¢å¤šå€‹ç®¡ç†å“¡
        const ADMIN_IDS = ['01845168778704975290']; 

        // å–å¾—ç’°å¢ƒæä¾›çš„æ‡‰ç”¨ç¨‹å¼ ID 
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // é…ç½®æ–‡ä»¶çš„è·¯å¾‘ï¼Œå¿…é ˆåœ¨ APP_ID å®šç¾©ä¹‹å¾Œ
        const CONFIG_DOC_PATH = `/artifacts/${APP_ID}/public/data/config/general`;

        // Firestore å…¨åŸŸè®Šæ•¸
        let db;
        let auth;
        let userId = 'loading';
        let recordToDeleteId = null; // å„²å­˜å¾…åˆªé™¤çš„ç´€éŒ„ ID
        let recordToCommentId = null; // å„²å­˜å¾…ç•™è¨€çš„ç´€éŒ„ ID
        let appConfig = { allowComments: true }; // å„²å­˜æ‡‰ç”¨ç¨‹å¼é…ç½®
        
        // æ–°å¢å…¨åŸŸè®Šæ•¸ä¾†å„²å­˜æ‰€æœ‰åŸå§‹ç´€éŒ„ï¼Œä»¥ä¾¿åœ¨å®¢æˆ¶ç«¯é€²è¡Œç¯©é¸
        let allRecords = []; 
        
        // NEW: å„²å­˜å¾…è™•ç†çš„ç®¡ç†å“¡å‹•ä½œ (æ¸…ç©º/åŒ¯å…¥ç¢ºèª)
        let pendingAdminAction = null; 

        // æª¢æŸ¥ä¸¦ä½¿ç”¨ Firebase Config
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            try {
                // è¨­ç½®æ—¥èªŒç´šåˆ¥ç‚º Debug
                setLogLevel('debug'); 
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // å˜—è©¦è¨­å®šæŒä¹…åŒ– (å¯é¸ï¼Œä½†æ¨è–¦)
                setPersistence(auth, browserLocalPersistence).catch((error) => { 
                    console.error("Error setting persistence:", error);
                });

                // è™•ç†èªè­‰ç‹€æ…‹
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth State Changed: Logged in as", userId);
                    } else {
                        // å˜—è©¦ä½¿ç”¨è‡ªå®šç¾© token ç™»å…¥ï¼Œæˆ–åŒ¿åç™»å…¥
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Sign-In Error:", error);
                            // å¦‚æœç™»å…¥å¤±æ•—ï¼Œä½¿ç”¨éš¨æ©Ÿ ID ä½œç‚ºåŒ¿åç”¨æˆ¶æ¨™è­˜
                            userId = crypto.randomUUID();
                        }
                    }
                    
                    // æ–°å¢: æ›´æ–°å³ä¸Šè§’ç›®å‰ä½¿ç”¨è€…IDçš„é¡¯ç¤º
                    const userIdDisplaySpan = document.getElementById('currentUserIdDisplay');
                    if (userIdDisplaySpan) {
                        userIdDisplaySpan.textContent = `ç•¶å‰ç”¨æˆ¶ ID: ${userId}`;
                    }
                    
                    // ç„¡è«–ç™»å…¥ç‹€æ…‹å¦‚ä½•ï¼Œéƒ½åˆå§‹åŒ–è³‡æ–™ç›£è½ã€é…ç½®ç›£è½å’Œç¯©é¸å™¨
                    setupRealtimeListener(db);
                    setupConfigListener(db);
                    initializeConfig(db);
                    updateAdminUI(); 
                    setupFilterListeners(); // <-- è¨­ç½®ç¯©é¸å™¨å’Œæ’åºäº‹ä»¶ç›£è½å™¨
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                document.getElementById('loadingIndicator').innerHTML = 'Firebase é€£ç·šå¤±æ•—ã€‚';
            }
        } else {
            console.error("Firebase Config Missing.");
            document.getElementById('loadingIndicator').innerHTML = 'éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° Firebase é…ç½®ã€‚';
        }

        // --- ç¯©é¸å™¨äº‹ä»¶ç›£è½å™¨è¨­ç½® ---

        /**
         * è¨­ç½®æ‰€æœ‰ç¯©é¸å™¨ UI å…ƒç´ çš„äº‹ä»¶ç›£è½å™¨ã€‚
         */
        function setupFilterListeners() {
            // filterAndRender å·²ç¶“è¢«è¨­ç½®ç‚º window å±¬æ€§ï¼Œå¯ä»¥ç›´æ¥å­˜å–
            const classSelect = document.getElementById('classFilterSelect');
            const timeSelect = document.getElementById('timeFilterSelect');
            const sortSelect = document.getElementById('sortSelect'); // <-- æ–°å¢: æ’åºä¸‹æ‹‰é¸å–®
            const nameInput = document.getElementById('nameFilterInput');
            const bookInput = document.getElementById('bookTitleFilterInput');

            // å°ä¸‹æ‹‰é¸å–®ä½¿ç”¨ 'change' äº‹ä»¶
            if (classSelect) classSelect.addEventListener('change', window.filterAndRender);
            if (timeSelect) timeSelect.addEventListener('change', window.filterAndRender);
            if (sortSelect) sortSelect.addEventListener('change', window.filterAndRender); // <-- æ–°å¢: æ’åºç›£è½
            
            // å°è¼¸å…¥æ¡†ä½¿ç”¨ 'input' äº‹ä»¶é€²è¡Œå¯¦æ™‚ç¯©é¸
            if (nameInput) nameInput.addEventListener('input', window.filterAndRender);
            if (bookInput) bookInput.addEventListener('input', window.filterAndRender);
            
            console.log("Filter listeners set up.");
        }


        // --- Firestore æ ¸å¿ƒåŠŸèƒ½ ---
        
        // å…¬å…±è³‡æ–™è·¯å¾‘ï¼š/artifacts/{appId}/public/data/reading_checkins (è®“æ‰€æœ‰ä½¿ç”¨è€…å¯è¦‹)
        const getCollectionPath = () => `/artifacts/${APP_ID}/public/data/reading_checkins`;


        /**
         * è¨­ç½®å¯¦æ™‚æ•¸æ“šç›£è½ (onSnapshot)
         * @param {Firestore} db - Firestore å¯¦ä¾‹
         */
        function setupRealtimeListener(db) {
            if (!db) return;

            const collectionRef = collection(db, getCollectionPath());
            const q = query(collectionRef); 

            console.log("Setting up real-time listener for:", getCollectionPath());

            onSnapshot(q, (snapshot) => {
                const records = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Firestore Timestamp è½‰æ›ç‚º JavaScript Date
                    const timestampDate = data.timestamp ? data.timestamp.toDate() : null; 
                    
                    records.push({
                        id: doc.id,
                        ...data,
                        // å„²å­˜åŸå§‹ Date ç‰©ä»¶ï¼Œç”¨æ–¼ç¯©é¸å’Œæ’åº
                        timestampDate: timestampDate, 
                        // å„²å­˜æ ¼å¼åŒ–å­—ä¸²ï¼Œç”¨æ–¼é¡¯ç¤º
                        timestampStr: timestampDate ? timestampDate.toLocaleString('zh-TW', { hour12: false }) : 'N/A',
                        // ç¢ºä¿ likedBy é™£åˆ—å­˜åœ¨
                        likedBy: data.likedBy || [],
                        // ç¢ºä¿ comments é™£åˆ—å­˜åœ¨
                        comments: data.comments || [], 
                        // ç¢ºä¿ likes æ•¸å­—å­˜åœ¨
                        likes: data.likes || 0,
                    });
                });
                
                // å„²å­˜åŸå§‹æ•¸æ“šä¸¦è§¸ç™¼ç¯©é¸èˆ‡æ¸²æŸ“
                allRecords = records;
                
                // æ ¹æ“šç•¶å‰æ‰€æœ‰ç´€éŒ„æ›´æ–°ç­ç´šç¯©é¸ä¸‹æ‹‰é¸å–®
                populateClassFilter(allRecords); 
                
                filterAndRender(); 
                
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                document.getElementById('loadingIndicator').innerHTML = 'è¼‰å…¥ç´€éŒ„å¤±æ•—ã€‚';
            });
        }
        
        // --- ç¯©é¸åŠŸèƒ½é‚è¼¯ ---
        
        /**
         * æ ¹æ“šç´€éŒ„åˆ—è¡¨æ›´æ–°ç­ç´šç¯©é¸ä¸‹æ‹‰é¸å–®ã€‚
         * @param {Array<Object>} records - æ‰€æœ‰é–±è®€æ‰“å¡ç´€éŒ„
         */
        function populateClassFilter(records) {
            const selectElement = document.getElementById('classFilterSelect');
            if (!selectElement) return;

            // 1. å–å¾—ç•¶å‰é¸ä¸­çš„å€¼ (ä»¥ä¾¿åœ¨é‡æ–°ç”Ÿæˆåˆ—è¡¨å¾Œä¿æŒé¸æ“‡)
            const currentValue = selectElement.value;

            // 2. æ‰¾å‡ºæ‰€æœ‰ä¸é‡è¤‡çš„ç­ç´šåç¨±
            const uniqueClasses = new Set();
            records.forEach(record => {
                if (record.userClass && record.userClass.trim() !== '') {
                    uniqueClasses.add(record.userClass.trim());
                }
            });
            
            // 3. æ¸…ç©ºä¸¦é‡å»ºé¸é …
            selectElement.innerHTML = '';
            
            // é è¨­é¸é …
            let optionsHtml = `<option value="">æ‰€æœ‰ç­ç´š</option>`;
            
            // æ’åºç­ç´šåç¨± (æŒ‰æ•¸å­—å’Œå­—æ¯é †åº)
            const sortedClasses = Array.from(uniqueClasses).sort((a, b) => a.localeCompare(b, 'zh-TW', { numeric: true }));

            sortedClasses.forEach(className => {
                // å¦‚æœé¸é …å€¼èˆ‡ç•¶å‰å€¼åŒ¹é…ï¼Œå‰‡ä¿ç•™ selected å±¬æ€§
                const selectedAttr = (className === currentValue) ? 'selected' : '';
                optionsHtml += `<option value="${className}" ${selectedAttr}>${className}</option>`;
            });

            selectElement.innerHTML = optionsHtml;
            
            // å¦‚æœèˆŠçš„å€¼ä¸å­˜åœ¨æ–¼æ–°åˆ—è¡¨ï¼Œå‰‡ç¢ºä¿ä¸‹æ‹‰é¸å–®é‡ç½®ç‚º "æ‰€æœ‰ç­ç´š"
            if (currentValue && !uniqueClasses.has(currentValue)) {
                 selectElement.value = "";
            }
        }

        /**
         * æ ¹æ“šæ™‚é–“ç¯„åœç¯©é¸å€¼è¨ˆç®—æˆªæ­¢æ—¥æœŸ (æœ€å°å…è¨±æ—¥æœŸ)ã€‚
         * @param {string} filterValue - ç¯©é¸å™¨é¸æ“‡çš„å€¼ (e.g., 'today', '3days')
         * @returns {Date} æˆªæ­¢æ—¥æœŸ Date ç‰©ä»¶ã€‚
         */
        function getCutoffDate(filterValue) {
            const now = new Date();
            const cutoff = new Date(now);

            switch (filterValue) {
                case 'today':
                    // æœ¬æ—¥: è¨­å®šç‚ºä»Šå¤© 00:00:00
                    cutoff.setHours(0, 0, 0, 0);
                    break;
                case '3days':
                    // ä¸‰æ—¥: æ¸›å» 3 å¤©
                    cutoff.setDate(now.getDate() - 3);
                    break;
                case 'thisweek':
                    // æœ¬é€±: è¨­å®šç‚ºæœ¬é€±çš„æ˜ŸæœŸä¸€ 00:00:00
                    // 0=é€±æ—¥, 1=é€±ä¸€... 6=é€±å…­
                    const day = now.getDay() || 7; // å°‡é€±æ—¥(0)è½‰ç‚º 7
                    cutoff.setDate(now.getDate() - day + 1); 
                    cutoff.setHours(0, 0, 0, 0);
                    break;
                case '2weeks':
                    // äºŒé€±: æ¸›å» 14 å¤©
                    cutoff.setDate(now.getDate() - 14);
                    break;
                case 'thismonth':
                    // æœ¬æœˆ: è¨­å®šç‚ºæœ¬æœˆ 1 è™Ÿ 00:00:00
                    cutoff.setDate(1);
                    cutoff.setHours(0, 0, 0, 0);
                    break;
                case '6months':
                    // åŠå¹´: æ¸›å» 6 å€‹æœˆ
                    cutoff.setMonth(now.getMonth() - 6);
                    break;
                case '1year':
                    // ä¸€å¹´: æ¸›å» 12 å€‹æœˆ
                    cutoff.setFullYear(now.getFullYear() - 1);
                    break;
                case 'all':
                default:
                    // æ‰€æœ‰æ™‚é–“: è¿”å›ä¸€å€‹éå¸¸æ—©çš„æ—¥æœŸ
                    return new Date(0); 
            }
            return cutoff;
        }


        /**
         * æ ¹æ“šç•¶å‰ç¯©é¸æ¢ä»¶éæ¿¾ allRecords ä¸¦å‘¼å« renderRecords æ¸²æŸ“çµæœã€‚
         */
        window.filterAndRender = function() {
            // 1. å–å¾—ç¯©é¸å€¼
            const nameFilter = (document.getElementById('nameFilterInput')?.value || '').toLowerCase().trim();
            const bookFilter = (document.getElementById('bookTitleFilterInput')?.value || '').toLowerCase().trim();
            const classFilter = (document.getElementById('classFilterSelect')?.value || '').trim(); 
            const timeFilter = (document.getElementById('timeFilterSelect')?.value || 'all').trim(); 
            // <-- NEW: å–å¾—æ’åºåå¥½
            const sortPreference = (document.getElementById('sortSelect')?.value || 'latest').trim(); 

            let filteredRecords = allRecords;
            
            // 2. æ‡‰ç”¨ç­ç´šç¯©é¸ (ç²¾ç¢ºåŒ¹é…)
            if (classFilter) {
                filteredRecords = filteredRecords.filter(record => 
                    record.userClass && record.userClass.trim() === classFilter 
                );
            }

            // 3. æ‡‰ç”¨å§“åç¯©é¸ (ä¸å€åˆ†å¤§å°å¯«)
            if (nameFilter) {
                filteredRecords = filteredRecords.filter(record => 
                    (record.userName || '').toLowerCase().includes(nameFilter)
                );
            }
            
            // 4. æ‡‰ç”¨æ›¸åç¯©é¸ (ä¸å€åˆ†å¤§å°å¯«)
            if (bookFilter) {
                filteredRecords = filteredRecords.filter(record => 
                    (record.bookTitle || '').toLowerCase().includes(bookFilter)
                );
            }
            
            // 5. æ‡‰ç”¨æ™‚é–“ç¯©é¸ (ä½¿ç”¨åŸå§‹ Date ç‰©ä»¶æ¯”è¼ƒ)
            if (timeFilter !== 'all') {
                const cutoffDate = getCutoffDate(timeFilter);
                filteredRecords = filteredRecords.filter(record => 
                    record.timestampDate && record.timestampDate >= cutoffDate
                );
            }

            // 6. æ¸²æŸ“æœ€çµ‚éæ¿¾å¾Œçš„åˆ—è¡¨ï¼Œä¸¦å‚³å…¥æ’åºåå¥½
            renderRecords(filteredRecords, sortPreference); 
        }

        // --- ç®¡ç†é…ç½®åŠŸèƒ½ ---

        /**
         * è¨­ç½®æ‡‰ç”¨ç¨‹å¼é…ç½®çš„å¯¦æ™‚ç›£è½å™¨ 
         * @param {Firestore} db - Firestore å¯¦ä¾‹
         */
        function setupConfigListener(db) {
            if (!db) return;
            
            // ç›£è½å–®ä¸€æ–‡ä»¶
            const configDocRef = doc(db, CONFIG_DOC_PATH);

            onSnapshot(configDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    appConfig = docSnap.data();
                    console.log("App config loaded:", appConfig);
                } else {
                    console.log("Config document not found. Using default config.");
                    appConfig = { allowComments: true };
                }
                
                // æ›´æ–° Admin UI ç‹€æ…‹ (å¦‚æœç•¶å‰ç”¨æˆ¶æ˜¯ç®¡ç†å“¡)
                updateAdminUI();
                // è§¸ç™¼é‡æ–°æ¸²æŸ“ä»¥æ ¹æ“šæ–°çš„é…ç½®æ›´æ–°ç•™è¨€æŒ‰éˆ•ç‹€æ…‹
                filterAndRender(); 
            }, (error) => {
                console.error("Error listening to Config:", error);
            });
        }

        /**
         * åˆå§‹åŒ– Config æ–‡ä»¶ (å¦‚æœä¸å­˜åœ¨) 
         */
        async function initializeConfig(db) {
            if (!db) return;
            const configDocRef = doc(db, CONFIG_DOC_PATH);
            try {
                const docSnap = await getDoc(configDocRef);
                if (!docSnap.exists()) {
                    await setDoc(configDocRef, {
                        allowComments: true
                    });
                    console.log("Initialized default config.");
                }
            } catch (e) {
                console.error("Error initializing config document:", e);
            }
        }

        /**
         * æ›´æ–° Admin UI ç‹€æ…‹ä¸¦è¨­ç½®äº‹ä»¶ç›£è½å™¨ 
         */
        function updateAdminUI() {
            const adminConfigDiv = document.getElementById('adminConfig');
            const allowCommentsToggle = document.getElementById('allowCommentsToggle');

            // 1. é¡¯ç¤ºç®¡ç†ä»‹é¢ (å¦‚æœç•¶å‰ç”¨æˆ¶æ˜¯ç®¡ç†å“¡)
            if (ADMIN_IDS.includes(userId)) {
                adminConfigDiv.classList.remove('hidden');
                allowCommentsToggle.checked = appConfig.allowComments;
            } else {
                adminConfigDiv.classList.add('hidden');
            }
        }

        /**
         * è™•ç†ç®¡ç†å“¡é…ç½®è®Šæ›´ 
         */
        window.handleConfigChange = async (event) => {
            if (!db || !ADMIN_IDS.includes(userId)) return;

            const newStatus = event.target.checked;
            const configDocRef = doc(db, CONFIG_DOC_PATH);
            
            try {
                await updateDoc(configDocRef, {
                    allowComments: newStatus
                });
                console.log("Config updated: allowComments =", newStatus);
            } catch (e) {
                console.error("Error updating config:", e);
                // å¦‚æœæ›´æ–°å¤±æ•—ï¼Œå°‡ UI ç‹€æ…‹é‚„åŸ
                event.target.checked = !newStatus; 
            }
        }
        
        // --- éš±è—/é¡¯ç¤ºåˆ‡æ›åŠŸèƒ½ ---
        
        /**
         * è™•ç†è¨˜éŒ„çš„éš±è—/é¡¯ç¤ºåˆ‡æ›åŠŸèƒ½ (åƒ…é™ç®¡ç†å“¡)
         * @param {string} recordId - ç´€éŒ„æ–‡ä»¶ ID
         * @param {boolean} currentStatus - è©²ç´€éŒ„ç›®å‰çš„éš±è—ç‹€æ…‹
         */
        window.handleToggleVisibility = async (recordId, currentStatus) => {
            if (!db || userId === 'loading' || !ADMIN_IDS.includes(userId)) {
                console.warn("Permission denied. Only admins can toggle visibility.");
                return;
            }
            
            const docRef = doc(db, getCollectionPath(), recordId);
            // newStatus: å¦‚æœç•¶å‰æ˜¯éš±è—(true)ï¼Œå‰‡æ–°ç‹€æ…‹æ˜¯é¡¯ç¤º(false)
            const newStatus = !currentStatus; 

            try {
                await updateDoc(docRef, {
                    hidden: newStatus
                });
                console.log(`Record ${recordId} visibility toggled to hidden: ${newStatus}`);
            } catch (e) {
                console.error("Error toggling visibility: ", e);
            }
        };


        // --- ç¾æœ‰åŠŸèƒ½ä¿®æ”¹ ---

        /**
         * è™•ç†æ‰“å¡æäº¤ (æ–°å¢ likedBy æ¬„ä½)
         */
        window.handleCheckin = async (event) => {
            event.preventDefault();

            const button = document.getElementById('submitButton');
            const messageBox = document.getElementById('messageBox');
            messageBox.classList.add('hidden');
            button.disabled = true;
            button.textContent = 'é€å‡ºä¸­...';

            const form = event.target;
            
            // æª¢æŸ¥é æ•¸ç¯„åœ
            const startPage = parseInt(form.startPage.value);
            const endPage = parseInt(form.endPage.value);
            if (endPage < startPage) {
                messageBox.textContent = 'çµæŸé ç¢¼ä¸èƒ½å°æ–¼é–‹å§‹é ç¢¼ã€‚';
                messageBox.classList.remove('hidden', 'text-green-600');
                messageBox.classList.add('text-red-500');
                button.disabled = false;
                button.textContent = 'é€å‡ºæ‰“å¡ç´€éŒ„';
                return;
            }

            const newRecord = {
                userId: userId, // ç•¶å‰ä½¿ç”¨è€… ID (ç”¨æ–¼å€åˆ†èª°æŒ‰è®šæˆ–ç•™è¨€)
                userName: form.nameInput.value,
                userClass: form.classSelect.value, // å¾æ–°çš„ input æ¬„ä½è®€å–
                bookTitle: form.bookTitle.value,
                startPage: startPage,
                endPage: endPage,
                thoughts: form.thoughts.value,
                moodEmoji: form.mood.value,
                rating: 5, // é»˜èªç‚º 5 æ˜Ÿ
                likes: 0,
                comments: [], // åˆå§‹åŒ–ç•™è¨€é™£åˆ—
                likedBy: [], // <-- åˆå§‹åŒ–æŒ‰è®šç”¨æˆ¶ ID é™£åˆ—
                hidden: false, // é è¨­ç‚ºé¡¯ç¤º
                timestamp: serverTimestamp() // ä½¿ç”¨ Firestore æœå‹™å™¨æ™‚é–“æˆ³
            };

            if (!db) {
                console.error("Firestore not initialized.");
                messageBox.textContent = 'éŒ¯èª¤ï¼šæ‡‰ç”¨ç¨‹å¼æœªæº–å‚™å¥½ã€‚';
                messageBox.classList.remove('hidden');
                button.disabled = false;
                button.textContent = 'é€å‡ºæ‰“å¡ç´€éŒ„';
                return;
            }

            try {
                // å°‡ç´€éŒ„æ–°å¢åˆ°å…¬å…±é›†åˆä¸­
                const docRef = await addDoc(collection(db, getCollectionPath()), newRecord);
                console.log("Document written with ID: ", docRef.id);

                messageBox.textContent = 'æ‰“å¡æˆåŠŸï¼æ‚¨çš„ç´€éŒ„å·²ç™¼å¸ƒã€‚';
                messageBox.classList.remove('hidden', 'text-red-500');
                messageBox.classList.add('text-green-600');
                form.reset(); // æ¸…ç©ºè¡¨å–®

            } catch (e) {
                console.error("Error adding document: ", e);
                messageBox.textContent = 'æ‰“å¡å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚';
                messageBox.classList.remove('hidden', 'text-green-600');
                messageBox.classList.add('text-red-500');
            } finally {
                button.disabled = false;
                button.textContent = 'é€å‡ºæ‰“å¡ç´€éŒ„';
            }
        };

        /**
         * è™•ç†å–®ä¸€ç”¨æˆ¶é»è®š/å–æ¶ˆé»è®šåŠŸèƒ½ (ä¿®æ­£ç‚º Like/Unlike Toggle)
         */
        window.handleLike = async (recordId) => {
            if (!db || userId === 'loading') {
                 console.warn("Firestore not ready or user ID loading.");
                 return;
            }
            
            const docRef = doc(db, getCollectionPath(), recordId);

            try {
                // 1. å–å¾—æœ€æ–°è³‡æ–™
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) return;
                const recordData = docSnap.data();

                // ç¢ºä¿ likedBy å­˜åœ¨ä¸”æ˜¯é™£åˆ—
                const likedBy = recordData.likedBy || [];
                const hasLiked = likedBy.includes(userId);

                let updatePayload = {};

                if (hasLiked) {
                    // åŸ·è¡Œå–æ¶ˆé»è®š (Unlike)
                    updatePayload = {
                        likes: increment(-1), // é»è®šæ•¸æ¸›ä¸€
                        likedBy: arrayRemove(userId) // å¾é™£åˆ—ä¸­ç§»é™¤ç”¨æˆ¶ ID
                    };
                    console.log(`User ${userId} unliked record ${recordId}.`);
                } else {
                    // åŸ·è¡Œé»è®š (Like)
                    updatePayload = {
                        likes: increment(1), // é»è®šæ•¸åŠ ä¸€
                        likedBy: arrayUnion(userId) // å°‡ç”¨æˆ¶ ID åŠ å…¥é™£åˆ—
                    };
                    console.log(`User ${userId} liked record ${recordId}.`);
                }

                // 2. åŸå­æ€§æ›´æ–°
                await updateDoc(docRef, updatePayload);
                
            } catch (e) {
                console.error("LIKE_TOGGLE_ERROR: Failed to update like status. Reason:", e);
                // å¯é¸ï¼šé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çµ¦ç”¨æˆ¶
            }
        };


        // --- ç´€éŒ„åˆªé™¤åŠŸèƒ½æ¨¡æ…‹è¦–çª—é‚è¼¯ (ç”¨æ–¼åˆªé™¤æ•´å€‹æ‰“å¡ç´€éŒ„) ---
        
        /**
         * é¡¯ç¤ºç¢ºèªåˆªé™¤çš„æ¨¡æ…‹è¦–çª—
         * @param {string} recordId - ç´€éŒ„æ–‡ä»¶ ID
         */
        window.handleDelete = (recordId) => {
            if (!ADMIN_IDS.includes(userId)) {
                console.warn("Permission denied. Only admins can delete records.");
                return;
            }
            recordToDeleteId = recordId;
            
            // é‡è¨­ Modal å…§å®¹ç‚ºå–®ç­†åˆªé™¤
            document.querySelector('#confirmationModal h3').textContent = 'ç¢ºèªåˆªé™¤ç´€éŒ„';
            document.querySelector('#confirmationModal p').textContent = 'æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™æ¢é–±è®€æ‰“å¡ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚';
            document.querySelector('#confirmationModal button:last-child').textContent = 'ç¢ºèªåˆªé™¤';
            pendingAdminAction = null; // æ¸…é™¤å…¶ä»–æ“ä½œ
            
            document.getElementById('confirmationModal').classList.remove('hidden');
        };
        
        
        // --- NEW: ç®¡ç†è³‡æ–™åŠŸèƒ½ (åŒ¯å‡ºã€åŒ¯å…¥ã€æ¸…ç©º) ---

        /**
         * é¡¯ç¤ºç®¡ç†å“¡æ“ä½œè¨Šæ¯
         * @param {string} message - é¡¯ç¤ºçš„å…§å®¹
         * @param {string} type - è¨Šæ¯é¡å‹ ('success', 'error', 'info')
         */
        function showAdminMessage(message, type = 'info') {
            const msgBox = document.getElementById('adminMessage');
            msgBox.textContent = message;
            msgBox.classList.remove('hidden', 'text-red-600', 'text-green-600', 'text-blue-600');
            
            let colorClass = 'text-blue-600';
            if (type === 'error') colorClass = 'text-red-600';
            if (type === 'success') colorClass = 'text-green-600';
            
            msgBox.classList.add(colorClass);
            msgBox.classList.remove('hidden');
            
            setTimeout(() => {
                msgBox.classList.add('hidden');
            }, 5000);
        }

        /**
         * è™•ç†è³‡æ–™åŒ¯å‡º (åƒ…é™ç®¡ç†å“¡)
         */
        window.handleExportData = async () => {
            if (!ADMIN_IDS.includes(userId) || !db) {
                showAdminMessage('æ¬Šé™ä¸è¶³æˆ–è³‡æ–™åº«æœªæº–å‚™å¥½ã€‚', 'error');
                return;
            }

            showAdminMessage('æ­£åœ¨åŒ¯å‡ºè³‡æ–™...', 'info');
            
            try {
                const recordsRef = collection(db, getCollectionPath());
                const snapshot = await getDocs(recordsRef);
                
                const dataToExport = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // å°‡ Firestore Timestamp è½‰æ›ç‚º ISO String ä»¥ä¾¿åŒ¯å‡ºå’ŒåŒ¯å…¥
                    const timestampStr = data.timestamp ? data.timestamp.toDate().toISOString() : null;
                    dataToExport.push({
                        id: doc.id,
                        ...data,
                        timestamp: timestampStr // ä½¿ç”¨ ISO String
                    });
                });

                // å»ºç«‹ JSON æª”æ¡ˆä¸¦ä¸‹è¼‰
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reading_checkins_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAdminMessage(`æˆåŠŸåŒ¯å‡º ${dataToExport.length} ç­†ç´€éŒ„ã€‚`, 'success');

            } catch (e) {
                console.error("Export Error:", e);
                showAdminMessage('åŒ¯å‡ºè³‡æ–™å¤±æ•—ã€‚', 'error');
            }
        };

        /**
         * è™•ç†è³‡æ–™åŒ¯å…¥ (åƒ…é™ç®¡ç†å“¡)
         */
        window.handleImportData = async (event) => {
            if (!ADMIN_IDS.includes(userId) || !db) {
                showAdminMessage('æ¬Šé™ä¸è¶³æˆ–è³‡æ–™åº«æœªæº–å‚™å¥½ã€‚', 'error');
                return;
            }

            const file = event.target.files[0];
            if (!file) {
                // æ¸…ç©º input è®“ä¸‹æ¬¡é»æ“Šå¯ä»¥å†æ¬¡è§¸ç™¼ onchange
                event.target.value = ''; 
                return;
            }

            showAdminMessage('æ­£åœ¨è®€å–æª”æ¡ˆ...', 'info');

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const jsonText = e.target.result;
                    const recordsToImport = JSON.parse(jsonText);

                    if (!Array.isArray(recordsToImport)) {
                        showAdminMessage('JSON æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œæ‡‰ç‚ºç´€éŒ„é™£åˆ—ã€‚', 'error');
                        return;
                    }

                    if (recordsToImport.length === 0) {
                         showAdminMessage('JSON æª”æ¡ˆä¸­æ²’æœ‰æ‰¾åˆ°ä»»ä½•ç´€éŒ„ã€‚', 'error');
                        return;
                    }

                    // è­¦å‘Š: åŒ¯å…¥æœƒè¦†è“‹ç¾æœ‰è³‡æ–™ (ä½¿ç”¨ Promise ç­‰å¾… Modal ç¢ºèª)
                    const isConfirmed = await handleImportConfirmation();
                    if (!isConfirmed) {
                        showAdminMessage('åŒ¯å…¥å·²å–æ¶ˆã€‚', 'info');
                        // æ¸…ç©º input è®“ä¸‹æ¬¡é»æ“Šå¯ä»¥å†æ¬¡è§¸ç™¼ onchange
                        event.target.value = '';
                        return;
                    }
                    
                    showAdminMessage(`æ­£åœ¨æ¸…ç©ºèˆŠè³‡æ–™ä¸¦åŒ¯å…¥ ${recordsToImport.length} ç­†æ–°ç´€éŒ„...`, 'info');

                    // 1. æ¸…ç©ºèˆŠè³‡æ–™
                    await clearAllRecords(false); // ä¸é¡¯ç¤ºè¨Šæ¯

                    // 2. åŒ¯å…¥æ–°è³‡æ–™
                    let importCount = 0;
                    const recordsRef = collection(db, getCollectionPath());
                    
                    for (const record of recordsToImport) {
                        // å¿…é ˆç§»é™¤ 'id' æ¬„ä½ï¼Œå¦å‰‡æœƒä½œç‚ºä¸€èˆ¬æ¬„ä½å„²å­˜
                        const { id, ...data } = record; 
                        
                        // è™•ç†æ™‚é–“æˆ³ï¼šå°‡ ISO String è½‰æ›ç‚º Firestore Timestamp (ä½¿ç”¨ Date ç‰©ä»¶)
                        let timestampValue = serverTimestamp();
                        if (data.timestamp) {
                            try {
                                const date = new Date(data.timestamp);
                                if (!isNaN(date.getTime())) {
                                     // ä½¿ç”¨ Date ç‰©ä»¶ï¼ŒFirestore æœƒè‡ªå‹•è½‰æ›ç‚º Timestamp
                                    timestampValue = date; 
                                }
                            } catch (timeError) {
                                console.warn("Invalid timestamp in import data, using server timestamp.");
                            }
                        }
                        
                        // ä½¿ç”¨ addDoc è®“ Firestore ç”Ÿæˆæ–°çš„ ID
                        await addDoc(recordsRef, {
                            ...data,
                            timestamp: timestampValue
                        });
                        importCount++;
                    }

                    showAdminMessage(`æˆåŠŸåŒ¯å…¥ ${importCount} ç­†ç´€éŒ„ï¼`, 'success');
                    
                } catch (e) {
                    console.error("Import Error:", e);
                    showAdminMessage('åŒ¯å…¥è³‡æ–™å¤±æ•—ï¼š' + e.message, 'error');
                } finally {
                     // æ¸…ç©º input è®“ä¸‹æ¬¡é»æ“Šå¯ä»¥å†æ¬¡è§¸ç™¼ onchange
                    event.target.value = ''; 
                }
            };
            reader.readAsText(file);
        };
        
        /**
         * è™•ç†åŒ¯å…¥å‰çš„ç¢ºèª (ä½¿ç”¨ç¾æœ‰çš„ Modal çµæ§‹)
         */
        function handleImportConfirmation() {
            return new Promise((resolve) => {
                pendingAdminAction = {
                    type: 'import',
                    resolve: resolve
                };
                const modal = document.getElementById('confirmationModal');
                // è‡¨æ™‚ä¿®æ”¹ Modal å…§å®¹
                document.querySelector('#confirmationModal h3').textContent = 'âš ï¸ ç¢ºèªåŒ¯å…¥è³‡æ–™';
                document.querySelector('#confirmationModal p').textContent = 'åŒ¯å…¥å°‡æœƒæ¸…é™¤æ‰€æœ‰ç¾æœ‰ç´€éŒ„ä¸¦å¯«å…¥æ–°è³‡æ–™ã€‚æ‚¨ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ';
                document.querySelector('#confirmationModal button:last-child').textContent = 'ç¢ºèªåŒ¯å…¥';
                document.querySelector('#confirmationModal button:last-child').classList.replace('bg-red-600', 'bg-blue-600');
                document.querySelector('#confirmationModal button:last-child').classList.replace('hover:bg-red-700', 'hover:bg-blue-700');
                
                modal.classList.remove('hidden');
            });
        }

        /**
         * æç¤ºæ¸…ç©ºè³‡æ–™ (ä½¿ç”¨ç¾æœ‰çš„ Modal çµæ§‹)
         */
        window.handleClearDataPrompt = () => {
            if (!ADMIN_IDS.includes(userId) || !db) {
                showAdminMessage('æ¬Šé™ä¸è¶³æˆ–è³‡æ–™åº«æœªæº–å‚™å¥½ã€‚', 'error');
                return;
            }
            
            pendingAdminAction = {
                type: 'clear',
                resolve: null // Not using promise resolve here, but keeping structure consistent
            };
            
            const modal = document.getElementById('confirmationModal');
            // è‡¨æ™‚ä¿®æ”¹ Modal å…§å®¹
            document.querySelector('#confirmationModal h3').textContent = 'ğŸš¨ ç¢ºèªæ¸…ç©ºæ‰€æœ‰è³‡æ–™';
            document.querySelector('#confirmationModal p').textContent = 'æ­¤æ“ä½œå°‡**æ°¸ä¹…åˆªé™¤**æ‰€æœ‰é–±è®€æ‰“å¡ç´€éŒ„ã€‚æ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼æ‚¨ç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿ';
            document.querySelector('#confirmationModal button:last-child').textContent = 'ç¢ºèªæ¸…ç©º';
            document.querySelector('#confirmationModal button:last-child').classList.replace('bg-blue-600', 'bg-red-600');
            document.querySelector('#confirmationModal button:last-child').classList.replace('hover:bg-blue-700', 'hover:bg-red-700');
            
            modal.classList.remove('hidden');
        };

        /**
         * æ ¸å¿ƒæ¸…ç©ºæ‰€æœ‰ç´€éŒ„é‚è¼¯
         * @param {boolean} showMsg - æ˜¯å¦é¡¯ç¤ºæˆåŠŸ/å¤±æ•—è¨Šæ¯ (åŒ¯å…¥æ™‚ä¸éœ€è¦é¡¯ç¤º)
         */
        async function clearAllRecords(showMsg = true) {
            if (!ADMIN_IDS.includes(userId) || !db) {
                if(showMsg) showAdminMessage('æ¬Šé™ä¸è¶³ã€‚', 'error');
                return false;
            }

            if(showMsg) showAdminMessage('æ­£åœ¨æ¸…ç©ºæ‰€æœ‰ç´€éŒ„ (è«‹å‹¿é—œé–‰è¦–çª—)...', 'error');
            
            try {
                const recordsRef = collection(db, getCollectionPath());
                const snapshot = await getDocs(recordsRef);
                
                let deleteCount = 0;
                
                for (const doc of snapshot.docs) {
                     await deleteDoc(doc.ref);
                     deleteCount++;
                }
                
                if(showMsg) showAdminMessage(`æˆåŠŸæ¸…ç©ºæ‰€æœ‰ ${deleteCount} ç­†ç´€éŒ„ã€‚`, 'success');
                return true;

            } catch (e) {
                console.error("Clear Data Error:", e);
                if(showMsg) showAdminMessage('æ¸…ç©ºè³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«é€£ç·šã€‚', 'error');
                return false;
            }
        }
        
        // --- NEW: é€šç”¨ Modal å–æ¶ˆå’Œç¢ºèªè™•ç† (è¦†è“‹åŸæœ‰çš„) ---

        /**
         * é€šç”¨çš„å–æ¶ˆæ“ä½œ (é‚„åŸ Modal å…§å®¹)
         */
        window.cancelDelete = () => {
            document.getElementById('confirmationModal').classList.add('hidden');
            recordToDeleteId = null; 
            
            // å¦‚æœæœ‰æœªå®Œæˆçš„ Admin Action (å¦‚åŒ¯å…¥ç¢ºèª), å‰‡è§£æç‚º false
            if (pendingAdminAction && pendingAdminAction.resolve) {
                pendingAdminAction.resolve(false);
            }
            
            // é‚„åŸ Modal å…§å®¹ç‚ºå–®ç­†åˆªé™¤çš„é è¨­å€¼
            document.querySelector('#confirmationModal h3').textContent = 'ç¢ºèªåˆªé™¤ç´€éŒ„';
            document.querySelector('#confirmationModal p').textContent = 'æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™æ¢é–±è®€æ‰“å¡ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚';
            document.querySelector('#confirmationModal button:last-child').textContent = 'ç¢ºèªåˆªé™¤';
            document.querySelector('#confirmationModal button:last-child').classList.replace('bg-blue-600', 'bg-red-600');
            document.querySelector('#confirmationModal button:last-child').classList.replace('hover:bg-blue-700', 'hover:bg-red-700');
            pendingAdminAction = null; 
        };

        /**
         * é€šç”¨çš„ç¢ºèªæ“ä½œ (è™•ç†å–®ç­†åˆªé™¤ã€æ¸…ç©ºæˆ–åŒ¯å…¥)
         */
        window.confirmDelete = async () => {
            document.getElementById('confirmationModal').classList.add('hidden');
            
            if (pendingAdminAction && pendingAdminAction.type === 'clear') {
                // åŸ·è¡Œæ¸…ç©ºè³‡æ–™
                await clearAllRecords(true);
                
            } else if (pendingAdminAction && pendingAdminAction.type === 'import') {
                // è™•ç†åŒ¯å…¥ç¢ºèª
                if (pendingAdminAction.resolve) {
                    pendingAdminAction.resolve(true); // ç¹¼çºŒåŸ·è¡ŒåŒ¯å…¥
                }
                
            } else if (recordToDeleteId) {
                // åŸ·è¡Œå–®ç­†ç´€éŒ„åˆªé™¤
                const docRef = doc(db, getCollectionPath(), recordToDeleteId);
                try {
                    await deleteDoc(docRef);
                    console.log("Document successfully deleted:", recordToDeleteId);
                    recordToDeleteId = null; 
                    showAdminMessage('å–®ç­†ç´€éŒ„åˆªé™¤æˆåŠŸã€‚', 'success');
                } catch (e) {
                    console.error("Error removing document: ", e);
                    showAdminMessage('åˆªé™¤ç´€éŒ„å¤±æ•—ã€‚', 'error');
                }
                
            } else {
                console.error("No action or record selected for confirmation.");
            }
            
            // è™•ç†å®Œæˆå¾Œï¼Œå‘¼å«å–æ¶ˆä»¥é‡è¨­ç‹€æ…‹å’Œ Modal å…§å®¹
            cancelDelete();
        };

        // --- ç•™è¨€åŠŸèƒ½æ¨¡æ…‹è¦–çª—é‚è¼¯ (ç”¨æ–¼æ–°å¢ç•™è¨€) ---


        /**
         * é¡¯ç¤ºæ–°å¢ç•™è¨€çš„æ¨¡æ…‹è¦–çª—
         * @param {string} recordId - ç´€éŒ„æ–‡ä»¶ ID
         */
        window.showCommentModal = (recordId) => {
            if (!appConfig.allowComments) {
                console.warn("ç•™è¨€åŠŸèƒ½ç›®å‰å·²è¢«ç®¡ç†å“¡é—œé–‰ã€‚");
                const messageBox = document.getElementById('messageBox');
                messageBox.textContent = 'ç•™è¨€åŠŸèƒ½ç›®å‰å·²è¢«ç®¡ç†å“¡é—œé–‰ã€‚';
                messageBox.classList.remove('hidden', 'text-green-600');
                messageBox.classList.add('text-red-500');
                setTimeout(() => messageBox.classList.add('hidden'), 3000);
                return;
            }
            
            recordToCommentId = recordId;
            document.getElementById('commentText').value = ''; // æ¸…ç©ºä¸Šä¸€æ¬¡çš„å…§å®¹
            
            // --- é¡¯ç¤ºä¸å¯ä¿®æ”¹çš„ç”¨æˆ¶ ID (ç¾åœ¨é¡¯ç¤ºå®Œæ•´ ID) ---
            const idDisplay = document.getElementById('commentUserIdDisplay');
            // é¡¯ç¤ºå®Œæ•´çš„ç”¨æˆ¶ ID
            idDisplay.textContent = `ID: ${userId}`; 
            // --- çµæŸæ–°å¢ ---
            
            document.getElementById('commentModal').classList.remove('hidden');
        };

        /**
         * å–æ¶ˆç•™è¨€ï¼Œéš±è—æ¨¡æ…‹è¦–çª—
         */
        window.cancelComment = () => {
            recordToCommentId = null;
            document.getElementById('commentModal').classList.add('hidden');
        };


        /**
         * è™•ç†ç•™è¨€æäº¤ä¸¦å¯«å…¥ Firestore
         */
        window.handleCommentSubmit = async (event) => {
            event.preventDefault();
            
            if (!appConfig.allowComments) {
                console.error("ç•™è¨€åŠŸèƒ½å·²è¢«ç®¡ç†å“¡é—œé–‰ï¼Œç„¡æ³•æäº¤ã€‚");
                window.cancelComment();
                return;
            }
            
            // åš´æ ¼çš„ ID æª¢æŸ¥
            if (!recordToCommentId || !db) {
                console.error("ç„¡æ³•ç•™è¨€: ç´€éŒ„ ID éºå¤±æˆ– Firestore æœªåˆå§‹åŒ–ã€‚");
                window.cancelComment(); 
                return;
            }

            const button = document.getElementById('commentSubmitButton');
            const commentText = document.getElementById('commentText').value.trim();
            
            if (commentText.length === 0) {
                // å¦‚æœç•™è¨€ç‚ºç©ºï¼Œä¸åšä»»ä½•æ“ä½œ
                return;
            }
            
            button.disabled = true;
            button.textContent = 'é€å‡ºä¸­...';

            const docRef = doc(db, getCollectionPath(), recordToCommentId); 
            
            // ç•™è¨€çµæ§‹åªåŒ…å« userId, text, timestamp
            const newComment = {
                userId: userId,
                text: commentText,
                // ä½¿ç”¨ ISO å­—ä¸²ä½œç‚ºå”¯ä¸€çš„æ™‚é–“æˆ³/è­˜åˆ¥ç¢¼
                timestamp: new Date().toISOString() 
            };

            try {
                // ä½¿ç”¨ arrayUnion å°‡æ–°çš„ç•™è¨€ç‰©ä»¶åŸå­æ€§åœ°æ·»åŠ åˆ° comments é™£åˆ—ä¸­
                await updateDoc(docRef, {
                    comments: arrayUnion(newComment)
                });
                
                console.log("Comment successfully added to:", recordToCommentId);
                
                // æˆåŠŸå¾Œæ¸…é™¤ ID å’Œé—œé–‰ modal
                window.cancelComment(); 

            } catch (e) {
                console.error("Error adding comment: ", e);
                // å¤±æ•—æ™‚ä¹Ÿæ¸…é™¤ ID å’Œé—œé–‰ modal
                window.cancelComment();
            } finally {
                // æœ€å¾Œåªé‡ç½®æŒ‰éˆ•ç‹€æ…‹
                button.disabled = false;
                button.textContent = 'é€å‡ºç•™è¨€';
            }
        };

        // --- åˆªé™¤å–®æ¢ç•™è¨€çš„åŠŸèƒ½ (åƒ…é™ç®¡ç†å“¡) ---
        
        /**
         * è™•ç†åˆªé™¤å–®æ¢ç•™è¨€çš„åŠŸèƒ½ (åƒ…é™ç®¡ç†å“¡)
         * @param {string} recordId - ç•™è¨€æ‰€åœ¨çš„æ‰“å¡ç´€éŒ„æ–‡ä»¶ ID
         * @param {string} commentTimestamp - ç•™è¨€ç‰©ä»¶çš„å”¯ä¸€æ™‚é–“æˆ³ (ISO å­—ä¸²)
         */
        window.handleDeleteComment = async (recordId, commentTimestamp) => {
            if (!db || !ADMIN_IDS.includes(userId)) {
                console.warn("Permission denied. Only admins can delete comments.");
                return;
            }
            
            // NOTE: å› ç‚ºç¦æ­¢ä½¿ç”¨ alert/confirmï¼Œç®¡ç†å“¡é»æ“Šå¾Œå°‡ç›´æ¥åŸ·è¡Œåˆªé™¤ã€‚
            // åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæ‡‰ä½¿ç”¨è‡ªå®šç¾©æ¨¡æ…‹è¦–çª—ä¾†ç¢ºèªåˆªé™¤ã€‚

            const docRef = doc(db, getCollectionPath(), recordId);

            try {
                // 1. è®€å–ç•¶å‰çš„ç´€éŒ„
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    console.error("Record not found for comment deletion.");
                    return;
                }
                
                const recordData = docSnap.data();
                
                // 2. éæ¿¾æ‰è¦åˆªé™¤çš„ç•™è¨€
                const existingComments = recordData.comments || [];
                
                const updatedComments = existingComments.filter(comment => {
                    // æ¯”è¼ƒ ISO æ ¼å¼çš„ timestamp å­—ä¸²ï¼Œæ‰¾åˆ°åŒ¹é…çš„å³åˆªé™¤
                    return comment.timestamp !== commentTimestamp; 
                });

                // 3. å°‡æ›´æ–°å¾Œçš„é™£åˆ—å¯«å›
                await updateDoc(docRef, {
                    comments: updatedComments
                });
                
                showAdminMessage('ç•™è¨€åˆªé™¤æˆåŠŸã€‚', 'success');
                console.log(`Comment with timestamp ${commentTimestamp} deleted from record ${recordId}.`);

            } catch (e) {
                console.error("Error deleting comment: ", e);
                showAdminMessage('åˆªé™¤ç•™è¨€å¤±æ•—ã€‚', 'error');
            }
        };


        // --- NEW: å…¨æ–‡æ”¾å¤§æ¨¡æ…‹è¦–çª—é‚è¼¯ ---

        /**
         * é¡¯ç¤ºå…¨æ–‡æª¢è¦–æ¨¡æ…‹è¦–çª—
         * @param {string} recordId - ç´€éŒ„æ–‡ä»¶ ID
         */
        window.showFullPostModal = (recordId) => {
            // æŸ¥æ‰¾ç´€éŒ„
            const record = allRecords.find(r => r.id === recordId);
            if (!record) {
                console.error("Record not found:", recordId);
                return;
            }

            // å¡«å……æ¨™é¡Œ
            const modalTitle = document.getElementById('fullPostTitle');
            modalTitle.textContent = `ã€Š${record.bookTitle}ã€‹ - é–±è®€ç´€éŒ„`;

            // å¡«å……å…§å®¹
            const contentDiv = document.getElementById('fullPostContent');
            
            // æ˜Ÿæ˜Ÿæ¸²æŸ“ (èˆ‡å¡ç‰‡æ¸²æŸ“é‚è¼¯ä¸€è‡´)
            const rating = record.rating || 5;
            const starsHtml = Array(5).fill(0).map((_, i) => 
                `<svg class="w-5 h-5 ${i < rating ? 'text-yellow-400' : 'text-gray-300'} fill-current" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.487 7.234l6.561-.955L10 1l2.952 5.279 6.561.955-4.758 4.011 1.123 6.545z"/></svg>`
            ).join('');

            // æ ¼å¼åŒ–ç•™è¨€å€å¡Š
            let commentsDisplayHtml = '';
            if (record.comments && record.comments.length > 0) {
                const sortedComments = [...record.comments].sort((a, b) => {
                    const getTimeInMs = (comment) => typeof comment.timestamp === 'string' ? new Date(comment.timestamp).getTime() : 0;
                    return getTimeInMs(b) - getTimeInMs(a);
                });

                commentsDisplayHtml = `
                    <div class="pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-bold text-gray-800 mb-2">ç•™è¨€å€ (${sortedComments.length}):</h4>
                        <div class="space-y-3">
                            ${sortedComments.map(comment => {
                                // --- NEW: é¡¯ç¤ºå®Œæ•´ ID ---
                                const commenterId = comment.userId || 'unknown';
                                const displayCommenterId = commenterId; // å®Œæ•´ ID
                                // --- çµæŸ NEW ---
                                
                                let commentTime = 'N/A';
                                if (comment.timestamp && new Date(comment.timestamp).getTime() > 0) {
                                    commentTime = new Date(comment.timestamp).toLocaleString('zh-TW', { hour12: false, month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                                }
                                
                                return `
                                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                        <p class="text-xs font-semibold text-blue-800">ç”¨æˆ¶ ID: ${displayCommenterId} 
                                            <span class="font-normal text-gray-500 ml-2">${commentTime}</span>
                                        </p>
                                        <p class="text-base text-gray-800 mt-1 whitespace-pre-wrap">${comment.text}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // ç¢ºä¿ record.userId æ˜¯ä¸€å€‹å­—ç¬¦ä¸²ï¼Œå¦‚æœç‚º null/undefinedï¼Œå‰‡ä½¿ç”¨ 'unknown'
            const displayUserId = String(record.userId || 'unknown');
            const truncatedUserId = displayUserId.substring(0, 8) + '...';

            contentDiv.innerHTML = `
                <div class="p-3 bg-red-50 rounded-lg border border-red-200 grid grid-cols-2 lg:grid-cols-4 gap-3">
                    <p class="text-sm font-semibold text-gray-700">ä½œè€…ï¼š<span class="text-red-700">${record.userName} (${record.userClass})</span></p>
                    <p class="text-sm font-semibold text-gray-700">å¿ƒæƒ…ï¼š<span class="text-xl">${record.moodEmoji}</span></p>
                    <p class="text-sm font-semibold text-gray-700">æ™‚é–“ï¼š<span class="text-gray-600">${record.timestampStr.split(' ')[0]}</span></p>
                    <p class="text-sm font-semibold text-gray-700">ç™¼ä½ˆ IDï¼š<span class="text-gray-600 font-mono">${truncatedUserId}</span></p>
                </div>
                
                <div class="p-3 border-b border-gray-200 flex items-center justify-between">
                    <div class="flex items-center space-x-1">
                        ${starsHtml}
                    </div>
                    <span class="text-sm text-gray-600 ml-4">é–±è®€é æ•¸ï¼š${record.startPage} - ${record.endPage} é </span>
                    <span class="text-sm text-red-600 ml-auto flex items-center">
                        <svg class="w-4 h-4 text-red-500 fill-current mr-1" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        ${record.likes || 0} å€‹è®š
                    </span>
                </div>

                <div class="p-3 pt-0">
                    <h4 class="text-lg font-bold text-gray-800 mb-2 mt-4">é–±è®€æ™‚è…¦ä¸­ç”¢ç”Ÿçš„æƒ³æ³• (å…¨æ–‡)ï¼š</h4>
                    <!-- ä½¿ç”¨ whitespace-pre-wrap ä¿ç•™æ›è¡Œ -->
                    <p class="text-base lg:text-lg text-gray-800 whitespace-pre-wrap p-3 border border-gray-100 rounded-lg bg-gray-50">${record.thoughts}</p>
                </div>
                
                ${commentsDisplayHtml}
            `;

            // é¡¯ç¤ºæ¨¡æ…‹è¦–çª—
            document.getElementById('fullPostModal').classList.remove('hidden');
        };

        /**
         * é—œé–‰å…¨æ–‡æª¢è¦–æ¨¡æ…‹è¦–çª—
         */
        window.closeFullPostModal = () => {
            document.getElementById('fullPostModal').classList.add('hidden');
        };

        // --- UI æ¸²æŸ“åŠŸèƒ½ ---

        /**
         * æ¸²æŸ“ç´€éŒ„åˆ—è¡¨
         * @param {Array<Object>} recordsToRender - ç¶“éç¯©é¸çš„ç´€éŒ„åˆ—è¡¨
         * @param {string} sortPreference - æ’åºåå¥½ ('latest' æˆ– 'likes')
         */
        function renderRecords(recordsToRender, sortPreference = 'latest') {
            const container = document.getElementById('recordsContainer');
            container.innerHTML = ''; 
            
            // --- æ’åºé‚è¼¯ (å·²ä¿®æ”¹) ---
            recordsToRender.sort((a, b) => {
                if (sortPreference === 'likes') {
                    // ä¾è®šæ•¸æ’åº (é™åº: è®šæ•¸å¤šçš„åœ¨å‰)
                    const likesA = a.likes || 0;
                    const likesB = b.likes || 0;
                    if (likesB !== likesA) {
                         return likesB - likesA;
                    }
                    // è®šæ•¸ç›¸åŒæ™‚ï¼Œä¾æœ€æ–°æ™‚é–“æ’åº
                } 
                
                // ä¾æœ€æ–°æ™‚é–“æ’åº (é è¨­ï¼Œæˆ–è®šæ•¸ç›¸åŒæ™‚)
                const dateA = a.timestampDate || new Date(0); 
                const dateB = b.timestampDate || new Date(0);
                return dateB.getTime() - dateA.getTime();
            });

            // --- éæ¿¾éš±è—ç´€éŒ„çš„é‚è¼¯ (åªå°éç®¡ç†å“¡ç”Ÿæ•ˆ) ---
            let displayRecords = recordsToRender;
            if (!ADMIN_IDS.includes(userId)) {
                // å¦‚æœä¸æ˜¯ç®¡ç†å“¡ï¼Œå‰‡åªé¡¯ç¤º hidden å±¬æ€§ç‚º false æˆ–ä¸å­˜åœ¨çš„ç´€éŒ„
                displayRecords = recordsToRender.filter(record => record.hidden !== true);
            }
            // --- çµæŸéæ¿¾é‚è¼¯ ---

            if (displayRecords.length === 0) {
                container.innerHTML = `
                    <div class="md:col-span-2 text-center text-gray-500 p-8 bg-white rounded-xl shadow-lg">
                        ç›®å‰æ²’æœ‰ä»»ä½•æ‰“å¡ç´€éŒ„ã€‚å¿«æˆç‚ºç¬¬ä¸€å€‹å§ï¼
                    </div>
                `;
                return;
            }

            displayRecords.forEach(record => {
                const cardHtml = createRecordCard(record);
                container.innerHTML += cardHtml; 
            });
            const loadingIndicator = document.getElementById('loadingIndicator');
            if(loadingIndicator) loadingIndicator.remove();
        }

        /**
         * å»ºç«‹å–®å€‹é–±è®€ç´€éŒ„å¡ç‰‡çš„ HTML (å¢åŠ é»è®šç‹€æ…‹åˆ¤æ–·)
         */
        function createRecordCard(record) {
            // æ˜Ÿæ˜Ÿæ¸²æŸ“ (é»˜èªç‚º 5 é¡†æ˜Ÿ)
            const rating = record.rating || 5;
            const stars = Array(5).fill(0).map((_, i) => 
                `<svg class="w-5 h-5 ${i < rating ? 'text-yellow-400' : 'text-gray-300'} fill-current" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.487 7.234l6.561-.955L10 1l2.952 5.279 6.561.955-4.758 4.011 1.123 6.545z"/></svg>`
            ).join('');
            
            // åˆ¤æ–·ç•¶å‰ç”¨æˆ¶æ˜¯å¦å·²é»è®š (æ ¹æ“š likedBy é™£åˆ—)
            const isLiked = (record.likedBy || []).includes(userId);
            const likeIconClass = isLiked ? 'text-red-500 fill-current' : 'text-gray-400 fill-current hover:text-red-500';
            const likeButtonClass = isLiked ? 'text-red-500' : 'text-gray-600';


            // åªæœ‰ç®¡ç†å“¡æ‰é¡¯ç¤ºåˆªé™¤å’Œéš±å½¢æŒ‰éˆ•
            let adminButtons = '';
            // è¦–è¦ºæ¨™ç¤ºï¼šå¦‚æœæ–‡ç« è¢«éš±è—
            const isHidden = record.hidden === true; 
            const cardClass = isHidden && ADMIN_IDS.includes(userId) 
                ? 'bg-yellow-50 opacity-90 border-yellow-200' // éš±è—æ™‚è®Šç‚ºæ·¡é»ƒè‰²
                : 'bg-white border-red-100';

            let hiddenIndicator = '';

            if (ADMIN_IDS.includes(userId)) {
                const visibilityText = isHidden ? 'é¡¯ç¤º' : 'éš±å½¢';
                const visibilityColor = isHidden ? 'text-green-600 hover:text-green-800' : 'text-yellow-600 hover:text-yellow-800';
                // çœ¼ç›åœ–æ¨™
                const visibilityIcon = isHidden 
                    ? `<svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M12 4.5c4.71 0 8.8 3.01 10.36 7.5-.02.09-.04.18-.06.27-.12.44-.27.87-.45 1.28l-1.63-1.63c.09-.34.14-.7.14-1.07 0-3.31-2.69-6-6-6s-6 2.69-6 6c0 .37.05.73.14 1.07L4.09 13.06c-.18-.41-.33-.84-.45-1.28C3.2 7.51 7.29 4.5 12 4.5zm0 13c-4.71 0-8.8-3.01-10.36-7.5.02-.09.04-.18.06-.27.12.44.27.87.45 1.28l1.63 1.63c-.09-.34-.14-.7-.14-1.07 0 3.31 2.69 6 6 6s6-2.69 6-6c0-.37-.05-.73-.14-1.07l-1.63-1.63c.18.41.33.84.45 1.28C20.8 17.49 16.71 20.5 12 20.5z"/></svg>` 
                    : `<svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M12 7c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zM12 4.5c4.71 0 8.8 3.01 10.36 7.5-.02.09-.04.18-.06.27-.12.44-.27.87-.45 1.28L21.91 3.59l1.41 1.41L12 18.33 1.45 7.08l1.41-1.41L4.09 7.06c-.18-.41-.33-.84-.45-1.28C3.2 7.51 7.29 4.5 12 4.5zm0 13c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/></svg>`; 

                hiddenIndicator = isHidden
                    ? `<span class="bg-yellow-100 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">å·²éš±è— (åƒ…ç®¡ç†å“¡å¯è¦‹)</span>`
                    : '';
                
                adminButtons = `
                    <div class="flex space-x-3">
                        <!-- NEW: æ”¾å¤§æŒ‰éˆ• (å·²ä¿®æ­£æ–‡å­—) -->
                        <button onclick="showFullPostModal('${record.id}')"
                            class="text-blue-600 hover:text-blue-800 font-medium text-sm transition duration-150 flex items-center space-x-1 p-1 rounded hover:bg-blue-50"
                            title="æ”¾å¤§ (æ›´å¤§ç•«é¢æª¢è¦–)">
                            <!-- Icon: Expand/Zoom -->
                            <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5L20.49 19l-5-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zM12 10.5H10V12H9V10.5H7.5V9H9V7.5h1V9h2v1.5z"/></svg>
                            <span>æ”¾å¤§</span>
                        </button>

                        <!-- éš±å½¢/é¡¯ç¤ºæŒ‰éˆ• -->
                        <button onclick="handleToggleVisibility('${record.id}', ${isHidden})"
                            class="${visibilityColor} font-medium text-sm transition duration-150 flex items-center space-x-1 p-1 rounded hover:bg-yellow-100">
                            ${visibilityIcon}
                            <span>${visibilityText}</span>
                        </button>
                        <!-- åˆªé™¤æŒ‰éˆ• -->
                        <button onclick="handleDelete('${record.id}')"
                            class="text-red-500 hover:text-red-700 font-medium text-sm transition duration-150 flex items-center space-x-1 p-1 rounded hover:bg-red-50">
                            <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12l1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14l-2.13-2.12zM15.5 4l-1-1h-5l-1 1H5v2h14V4h-3.5z"/></svg>
                            <span>åˆªé™¤</span>
                        </button>
                    </div>
                `;
            }

            // æ ¹æ“š appConfig æ±ºå®šæ˜¯å¦é¡¯ç¤ºç•™è¨€æŒ‰éˆ•
            let commentButton = '';
            if (appConfig.allowComments) {
                commentButton = `
                    <button onclick="showCommentModal('${record.id}')"
                        class="text-blue-500 hover:text-blue-600 font-medium text-sm transition duration-150 flex items-center space-x-1">
                        <span>æ–°å¢ç•™è¨€...</span>
                    </button>
                `;
            } else {
                 commentButton = `
                    <span class="text-gray-400 font-medium text-sm flex items-center space-x-1 cursor-default">
                        <span>ç•™è¨€å·²é—œé–‰</span>
                    </span>
                `;
            }
            
            // ç•™è¨€å€å¡Šçš„ HTML é‚è¼¯
            let commentsHtml = '';
            if (record.comments && record.comments.length > 0) {
                
                // æ’åºç•™è¨€ï¼šè¶Šæ–°çš„æ’åœ¨è¶Šå‰é¢
                const sortedComments = [...record.comments].sort((a, b) => {
                    const getTimeInMs = (comment) => {
                        // æª¢æŸ¥æ™‚é–“æˆ³æ˜¯å¦ç‚º ISO å­—ä¸²
                        if (typeof comment.timestamp === 'string') {
                            return new Date(comment.timestamp).getTime();
                        }
                        return 0;
                    };
                    return getTimeInMs(b) - getTimeInMs(a);
                });
                
                commentsHtml = `
                    <div class="mt-4 pt-3 border-t border-gray-100">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">ç•™è¨€ (${sortedComments.length}):</h4>
                        <div class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar p-1">
                            ${sortedComments.map(comment => {
                                let commentTime = 'N/A';
                                if (comment.timestamp) {
                                    let dateObj;
                                    // æª¢æŸ¥æ™‚é–“æˆ³æ˜¯å¦ç‚º ISO å­—ä¸²
                                    if (typeof comment.timestamp === 'string') {
                                        dateObj = new Date(comment.timestamp);
                                    }
                                    
                                    if (dateObj && !isNaN(dateObj)) {
                                        commentTime = dateObj.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' });
                                    }
                                }
                                
                                // --- NEW: æ ¼å¼åŒ–ç•™è¨€è€…çš„ ID (å®Œæ•´ ID) ---
                                const commenterId = comment.userId || 'unknown';
                                const displayCommenterId = `ç”¨æˆ¶ ID: ${commenterId}`; 
                                // --- çµæŸ NEW ---
                                
                                // æ–°å¢ï¼šç®¡ç†å“¡åˆªé™¤ç•™è¨€æŒ‰éˆ•
                                let deleteCommentButton = '';
                                if (ADMIN_IDS.includes(userId)) {
                                    // å¿…é ˆå°‡ comment.timestamp å‚³éçµ¦åˆªé™¤å‡½æ•¸ä½œç‚ºå”¯ä¸€è­˜åˆ¥ç¢¼
                                    deleteCommentButton = `
                                        <button onclick="handleDeleteComment('${record.id}', '${comment.timestamp}')"
                                            class="ml-auto text-xs text-red-400 hover:text-red-600 transition duration-150"
                                            title="åˆªé™¤é€™æ¢ç•™è¨€">
                                            åˆªé™¤
                                        </button>
                                    `;
                                }

                                return `
                                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                        <div class="flex items-center">
                                            <p class="text-xs font-bold text-gray-800">${displayCommenterId}
                                                <span class="font-normal text-gray-400 ml-2">
                                                    ${commentTime}
                                                </span>
                                            </p>
                                            ${deleteCommentButton}
                                        </div>
                                        <p class="text-sm text-gray-700 mt-1 break-words">${comment.text}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // ç¢ºä¿ record.userId æ˜¯ä¸€å€‹å­—ç¬¦ä¸²ï¼Œå¦‚æœç‚º null/undefinedï¼Œå‰‡ä½¿ç”¨ 'unknown'
            const displayUserId = String(record.userId || 'unknown');

            // ä¸»å¡ç‰‡ä»ä½¿ç”¨æˆªæ–·çš„ä½œè€… IDï¼Œä»¥ç¯€çœç©ºé–“
            const truncatedUserId = displayUserId.substring(0, 8) + '...';


            return `
                <div class="${cardClass} p-6 rounded-2xl shadow-xl hover:shadow-2xl transition duration-300 flex flex-col" data-id="${record.id}">
                    <!-- Header: å§“åã€æ™‚é–“ -->
                    <div class="flex justify-between items-start mb-4 pb-3 border-b border-gray-100">
                        <div class="flex items-center space-x-2">
                            <span class="text-3xl">${record.moodEmoji}</span>
                            <div>
                                <p class="font-bold text-gray-800">${record.userName} (${record.userClass})</p>
                                <p class="text-xs text-gray-400">${record.timestampStr}</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            ${hiddenIndicator}
                            <span class="text-xs font-mono text-gray-400 select-all" title="User ID">ç”¨æˆ¶ ID: ${truncatedUserId}</span>
                        </div>
                    </div>

                    <!-- Book Title & Rating -->
                    <h3 class="text-xl font-extrabold text-red-600 mb-2">${record.bookTitle}</h3>
                    <div class="flex items-center space-x-1 mb-3">
                        ${stars}
                        <span class="text-xs text-gray-500 ml-2">é–±è®€é æ•¸ï¼š${record.startPage} - ${record.endPage} é </span>
                    </div>

                    <!-- Thoughts æƒ³æ³•å…§å®¹ -->
                    <p class="text-gray-800 text-base leading-relaxed mb-4 flex-grow custom-scrollbar overflow-y-auto max-h-40">
                        ${record.thoughts}
                    </p>

                    <!-- Actions å‹•ä½œå€ (è®š, éš±å½¢, åˆªé™¤, ç•™è¨€) -->
                    <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                        <!-- Like Button -->
                        <button onclick="handleLike('${record.id}')"
                            class="flex items-center space-x-1 font-medium ${likeButtonClass} transition duration-150 transform hover:scale-105">
                            <svg class="w-5 h-5 ${likeIconClass}" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            <span class="font-semibold">${record.likes || 0}</span>
                            <span class="text-sm">${isLiked ? 'å·²è®š' : 'è®š'}</span>
                        </button>
                        
                        <!-- Admin and Comment Buttons (Grouped right) -->
                        <div class="flex items-center space-x-4">
                            ${adminButtons}
                            ${commentButton} <!-- æ ¹æ“šé…ç½®é¡¯ç¤ºç•™è¨€æŒ‰éˆ•æˆ–ç‹€æ…‹ -->
                        </div>
                    </div>
                    
                    <!-- Comments Display Area -->
                    ${commentsHtml}
                </div>
            `;
        }

        /**
         * è¼”åŠ©å‡½æ•¸ï¼šæ¸…é™¤ç¯©é¸æ¢ä»¶
         */
        window.clearFilters = () => {
            const nameInput = document.getElementById('nameFilterInput');
            const bookInput = document.getElementById('bookTitleFilterInput');
            const classSelect = document.getElementById('classFilterSelect'); 
            const timeSelect = document.getElementById('timeFilterSelect'); 
            const sortSelect = document.getElementById('sortSelect'); // <-- æ–°å¢
            
            // æ¸…ç©ºè¼¸å…¥æ¡†
            if (nameInput) nameInput.value = '';
            if (bookInput) bookInput.value = '';
            
            // é‡ç½®ä¸‹æ‹‰é¸å–®
            if (classSelect) classSelect.value = '';
            if (timeSelect) timeSelect.value = 'all'; 
            if (sortSelect) sortSelect.value = 'latest'; // <-- é‡è¨­ç‚ºä¾æœ€æ–°æ’åº

            // é‡æ–°æ¸²æŸ“å…¨éƒ¨ç´€éŒ„
            filterAndRender();
        }

    </script>
</body>
</html>



